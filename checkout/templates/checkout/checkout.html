{% extends "base.html" %}
{% load static %}
{% load cart_tools %}

{% block extracss %}
    <link rel="stylesheet" href="{% static 'cart/css/cart.css' %}"> 
    <link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">     
{% endblock %}

{% block content %}
    <div class="container">  
        <!--Summary-->
        <div class="row">
            <div class="col-12 checkout-header">
                <p>
                    Summary
                </p>   
                <hr class="cart-separator">   
            </div>
        </div>
        <div class="row cart-items-header lg-font">
            <div class="col-2 offset-1"></div>
            <div class="col-2">
                <p class="cart-item-header">Toy</p>
            </div>
            <div class="col-2">
                <p class="cart-item-header">Price</p>
            </div>
            <div class="col-2">
                <p class="cart-item-header">Quantity</p>
            </div>
            <div class="col-2">
                <p class="cart-item-header">Subtotal</p>
            </div>                
        </div>          
        {% for item in cart_items %}                 
        <div class="row md-font">                   
            <div class="col-2 offset-1">
                <a href="{% url 'toy_detail' item.toy.id %}">
                    <img src="../media/{{ item.toy.image }}"    class="cart-image" alt="">
                </a>
            </div>
            <div class="col-2 cart-items">
                <p>{{ item.toy.name }}</p>
            </div>
            <div class="col-2 cart-items">
                <p>£{{ item.toy.price }}</p>
            </div>   
            <div class="col-2 cart-items">
                <p>{{ item.quantity }}</p>
            </div>                        
            <div class="col-2 cart-items">
                <p>£{{ item.toy.price | cart_subtotal:item.quantity }}</p>
            </div>                                               
        </div>
        <hr>
        {% endfor %}                 
        <div class="row cart-total">
            <div class="col-2 offset-7">
                <p class="cart-item-header">Total</p>
            </div>
            <div class="col-2">
                <p>£{{ total }}</p>
            </div>
        </div>
        <!--Shipping Information-->                   
        <div class="row">
            <div class="col-12 checkout-header">
                <p>
                    Shipping Information
                </p>   
                <hr class="cart-separator">   
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <form action="{% url 'checkout' %}" method="POST" id="checkout-form">
                    {% csrf_token %}
                    <fieldset>
                        <legend>Shipping Adddress</legend>
                        {{ order_form.first_name | as_crispy_field }}
                        {{ order_form.last_name | as_crispy_field }}       
                        {{ order_form.email_address | as_crispy_field }}  
                        {{ order_form.address | as_crispy_field }}   
                        {{ order_form.postcode | as_crispy_field }}  
                        {{ order_form.town | as_crispy_field }}  
                        {{ order_form.country | as_crispy_field }}
                        {{ order_form.comments | as_crispy_field }} 
                    </fieldset>        
                    <fieldset class="px-3 mt-5 mb-5">
                        <legend class="fieldset-label large text-black px-2 w-auto">
                            Payment Card
                        </legend>
                        <!-- A Stripe card element will go here -->
                        <div class="mb-3" id="card-element"></div>

                        <!-- Used to display form errors -->
                        <div class="mb-3 text-danger" id="card-errors" role="alert"></div>                       

                    </fieldset>
                </form>                
            </div>
        </div>   
        <div class="row cart-total">
            <div class="col-3 offset-3">
                <a href="{% url 'view_cart' %}">
                    <button>Back to Cart</button>
                </a>
                <a href="{% url 'view_cart' %}">
                    <button>Buy Now</button>
                </a>                                   
            </div>        
        </div>                
    </div>


{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    {{ stripe_public_key|json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }} 
    <script src="{% static 'checkout/js/stripe.js' %}"></script>       <script src="https://js.stripe.com/v3/"></script>  
{% endblock %}